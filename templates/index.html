<!DOCTYPE html>
<html>
<head>
    <title>Intelligent Recon Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #0f1117;
            color: white;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        .inputs {
            text-align: center;
            margin-bottom: 20px;
        }

        input {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            border: none;
        }

        button {
            padding: 8px 15px;
            margin: 5px;
            border-radius: 5px;
            border: none;
            background-color: #1f6feb;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #388bfd;
        }

        .dashboard {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .results-box,
        .chart-box {
            flex: 1;
            background-color: #161b22;
            padding: 20px;
            border-radius: 10px;
            min-height: 400px;
        }

        #results div {
            padding: 8px;
            border-bottom: 1px solid #30363d;
        }

        canvas {
            background: white;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<div class="container">

    <h1>ðŸ›¡ Intelligent Recon Dashboard</h1>

    <div class="inputs">
        <input type="text" id="target" placeholder="Enter IP or Domain">
        <input type="number" id="start_port" placeholder="Start Port">
        <input type="number" id="end_port" placeholder="End Port">

        <label>
            <input type="radio" name="mode" value="custom" checked>
            Custom Scan
        </label>

        <label>
            <input type="radio" name="mode" value="top">
            Top 100 Ports
        </label>

        <br>

        <button onclick="startScan()">Start Scan</button>
        <button onclick="downloadReport()">Download Report</button>
    </div>

    <h3 id="risk" style="text-align:center;"></h3>

    <div class="dashboard">

        <div class="results-box">
            <h2>Scan Results</h2>
            <div id="results"></div>
        </div>

        <div class="chart-box">
            <h2>Service Distribution</h2>
            <canvas id="chart"></canvas>
        </div>

    </div>

</div>

<!-- SCRIPT -->
<script>
let lastScanData = null;

function startScan() {

    const target = document.getElementById("target").value;
    const start_port = document.getElementById("start_port").value;
    const end_port = document.getElementById("end_port").value;
    const mode = document.querySelector('input[name="mode"]:checked').value;

    fetch("/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target, start_port, end_port, mode })
    })
    .then(res => res.json())
    .then(data => {

        lastScanData = data;

        document.getElementById("risk").innerHTML =
            "Overall Risk Score: " + data.risk_score;

        let output = "";
        let serviceCount = {};

        data.results.forEach(item => {

            output += `<div>
                Port ${item.port} -
                ${item.service} -
                Risk: ${item.risk}
            </div>`;

            serviceCount[item.service] =
                (serviceCount[item.service] || 0) + 1;
        });

        document.getElementById("results").innerHTML = output;

        if (window.myChart) {
            window.myChart.destroy();
        }

        const ctx = document.getElementById("chart").getContext("2d");

        window.myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: Object.keys(serviceCount),
                datasets: [{
                    label: "Service Distribution",
                    data: Object.values(serviceCount)
                }]
            }
        });
    });
}

function downloadReport() {

    if (!lastScanData) {
        alert("No scan data available!");
        return;
    }

    fetch("/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastScanData)
    })
    .then(res => res.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "scan_report.txt";
        a.click();
    });
}
</script>

</body>
</html>
